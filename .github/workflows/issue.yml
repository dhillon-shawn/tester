name: Create branch and PR for issues

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: issues
  cancel-in-progress: true

jobs:
  issue_to_pr:
    if: >
      contains(join(github.event.issue.labels.*.name, ','), 'release') ||
      contains(join(github.event.issue.labels.*.name, ','), 'hotfix')
    runs-on: ubuntu-latest

    steps:
      - name: assign check
        id: check
        run: |
          echo "issue_number=${{ github.event.issue.number }}"
          echo "assignees_json=${{ toJson(github.event.issue.assignees) }}"
          if [ "${{ toJson(github.event.issue.assignees) }}" = "[]" ]; then
            echo "has_assignees=false" >> $GITHUB_OUTPUT
            echo "result=no current assignee"
          else
            echo "has_assignees=true" >> $GITHUB_OUTPUT
            echo "result=already assigned"
          fi

      - name: assign ensure
        if: steps.check.outputs.has_assignees == 'false'
        uses: pozil/auto-assign-issue@v2
        with:
          assignees: "${{ github.event.issue.user.login }}"
          numOfAssignee: 1

      - name: issue refresh
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const num = context.payload.issue.number;
            const { data: issue } = await github.rest.issues.get({ ...repo, issue_number: num });
            const labels = (issue.labels || []).map(l => typeof l === 'string' ? l : l.name);
            const mode = labels.includes('hotfix') ? 'hotfix' : 'release';
            core.info(`issue: #${num} | mode=${mode} | labels=[${labels.join(', ')}] | assignees=[${(issue.assignees||[]).map(a=>a.login).join(', ')}]`);
            core.setOutput('title', issue.title || '');
            core.setOutput('body', issue.body || '');
            core.setOutput('labels', JSON.stringify(labels));
            core.setOutput('assignees', JSON.stringify((issue.assignees || []).map(a => a.login)));
            core.setOutput('milestone', issue.milestone ? String(issue.milestone.number) : '');
            core.setOutput('mode', mode);

      - name: meta derive
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = context.payload.issue.number;
            const nextPrNumber = issueNum + 1;
            const defaultBranch = context.payload.repository.default_branch;
            const mode = '${{ steps.issue.outputs.mode }}';
            const rawTitle = ${{ toJson(steps.issue.outputs.title) }};
            const title = rawTitle || mode;
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,50) || mode;
            const branch = `${mode}/${nextPrNumber}-${slug}`;
            const isDraft = mode === 'release';
            const prefix = isDraft ? 'Release: ' : 'Hotfix: ';
            core.info(`meta: issue=${issueNum} -> planned_pr=${nextPrNumber} | mode=${mode} | draft=${isDraft} | branch=${branch} | default=${defaultBranch}`);
            core.setOutput('default', defaultBranch);
            core.setOutput('branch', branch);
            core.setOutput('plannedPr', String(nextPrNumber));
            core.setOutput('isDraft', String(isDraft));
            core.setOutput('prefix', prefix);
            core.setOutput('slug', slug);

      - name: checkout default
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.meta.outputs.default }}

      - name: branch init
        env:
          BRANCH: ${{ steps.meta.outputs.branch }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          MODE: ${{ steps.issue.outputs.mode }}
        run: |
          echo "creating branch=$BRANCH from default=${{ steps.meta.outputs.default }} for issue #$ISSUE_NUMBER mode=$MODE"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git switch -c "$BRANCH"
          git commit --allow-empty -m "chore: init $MODE branch for #$ISSUE_NUMBER [skip ci]"
          git push --set-upstream origin "$BRANCH"
          echo "pushed branch=$BRANCH"

      - name: pr open
        id: createpr
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const issue_number = context.payload.issue.number;
            const base = '${{ steps.meta.outputs.default }}';
            const head = '${{ steps.meta.outputs.branch }}';
            const isDraft = '${{ steps.meta.outputs.isDraft }}' === 'true';
            const title = '${{ steps.meta.outputs.prefix }}' + ${{ toJson(steps.issue.outputs.title) }};
            const body = [
              `${isDraft ? 'Draft PR' : 'PR'} for issue #${issue_number}`,
              '',
              `Closes #${issue_number}`,
              '',
              '---',
              ${{ toJson(steps.issue.outputs.body) }}
            ].join('\n');
            const { data: pr } = await github.rest.pulls.create({ ...repo, title, head, base, body, draft: isDraft });
            const labels = JSON.parse('${{ steps.issue.outputs.labels }}');
            if (labels.length) await github.rest.issues.addLabels({ ...repo, issue_number: pr.number, labels });
            const milestone = '${{ steps.issue.outputs.milestone }}';
            if (milestone) await github.rest.issues.update({ ...repo, issue_number: pr.number, milestone: Number(milestone) });
            const assignees = JSON.parse('${{ steps.issue.outputs.assignees }}');
            const finalAssignees = assignees.length ? assignees : ['${{ github.event.issue.user.login }}'];
            await github.rest.issues.addAssignees({ ...repo, issue_number: pr.number, assignees: finalAssignees });
            core.info(`pr: actual=${pr.number} | planned=${'${{ steps.meta.outputs.plannedPr }}'} | url=${pr.html_url} | head=${head} -> base=${base} | draft=${isDraft}`);
            core.setOutput('pr_number', String(pr.number));
            core.setOutput('pr_url', pr.html_url)

      - name: pr verify
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const planned = Number('${{ steps.meta.outputs.plannedPr }}');
            const actual  = Number('${{ steps.createpr.outputs.pr_number }}');
            if (planned !== actual) {
              core.warning(`verify: planned_pr=${planned} != actual_pr=${actual} (branch remains '${{ steps.meta.outputs.branch }}')`);
            } else {
              core.info(`verify: planned_pr matches actual_pr=${actual}`);
            }
