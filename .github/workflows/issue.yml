name: hotfix branch from reopened issue

on:
  issues:
    types: [reopened]

permissions:
  write-all

jobs:
  hotfix_from_pr_head:
    if: contains(join(github.event.issue.labels.*.name, ','), 'release') || contains(join(github.event.issue.labels.*.name, ','), 'hotfix')
    runs-on: ubuntu-latest

    steps:
      - name: find_merged_pr_and_meta
        id: find
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const issue_number = context.payload.issue.number;

            // find merged pr that closed this issue
            const query = `repo:${repo.owner}/${repo.repo} is:pr is:merged in:body "Closes #${issue_number}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 1, sort: 'updated', order: 'desc' });
            if (!search.data.items.length) core.setFailed(`no merged pr found for issue #${issue_number}`);
            const pr_number = search.data.items[0].number;

            const pr = (await github.rest.pulls.get({ ...repo, pull_number: pr_number })).data;
            if (!pr.merged) core.setFailed(`pr #${pr_number} is not merged`);

            // optional rc-meta.json (no generic GET calls)
            let rc_version = '';
            let rc_commit  = '';
            try {
              const rel = await github.rest.repos.getReleaseByTag({ ...repo, tag: `rc-pr-${pr_number}` });
              const asset = (rel.data.assets || []).find(a => a.name === 'rc-meta.json');
              if (asset) {
                const bin = await github.rest.repos.getReleaseAsset({
                  ...repo,
                  asset_id: asset.id,
                  headers: { accept: 'application/octet-stream' }
                });
                const meta = JSON.parse(Buffer.from(bin.data).toString('utf8'));
                rc_version = meta.version || '';
                rc_commit  = meta.commit  || '';
              }
            } catch (_) {}

            const issue = context.payload.issue;
            const issue_title = issue.title || pr.title || '';
            const issue_body  = issue.body || '';
            const labels      = (issue.labels || []).map(l => typeof l === 'string' ? l : l.name);
            const assignees   = (issue.assignees || []).map(a => a.login);
            const milestone   = issue.milestone ? String(issue.milestone.number) : '';

            core.info(`issue=${issue_number} -> pr=${pr_number} base_ref=${pr.base.ref}`);

            core.setOutput('pr_number', String(pr_number));
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('issue_title', issue_title);
            core.setOutput('issue_body', issue_body);
            core.setOutput('labels_json', JSON.stringify(labels));
            core.setOutput('assignees_json', JSON.stringify(assignees));
            core.setOutput('milestone', milestone);
            core.setOutput('rc_version', rc_version);
            core.setOutput('rc_commit', rc_commit);

      - name: checkout_minimal
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: create_hotfix_branch_from_pr_head
        id: branch
        env:
          pr_number: ${{ steps.find.outputs.pr_number }}
          issue_title: ${{ steps.find.outputs.issue_title }}
        run: |
          set -euo pipefail
          slug="$(printf "%s" "$issue_title" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g; s/^$/hotfix/')"
          branch="hotfix/${pr_number}-${slug}"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # fetch immutable pr head ref that github keeps (works for old merges / deleted branches / forks)
          git fetch origin pull/${pr_number}/head:refs/remotes/origin/pr-${pr_number}-head
          git switch --detach origin/pr-${pr_number}-head
          git switch -c "$branch"

          # empty commit so pr always opens cleanly
          git commit --allow-empty -m "chore: initialize hotfix from pr #${pr_number} [skip ci]"
          git push --set-upstream origin "$branch"

          echo "created and pushed $branch from refs/pull/${pr_number}/head"

      - name: open_hotfix_pr
        id: pr_open
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const base_ref = '${{ steps.find.outputs.base_ref }}';
            const head_ref = '${{ steps.branch.outputs.branch }}';
            const pr_number = Number('${{ steps.find.outputs.pr_number }}');

            const title = `fix: follow-up for pr #${pr_number}`;

            const lines = [];
            const rc_version = '${{ steps.find.outputs.rc_version }}';
            const rc_commit  = '${{ steps.find.outputs.rc_commit }}';
            if (rc_version) lines.push(`version: \`${rc_version}\``);
            if (rc_commit)  lines.push(`release commit: \`${rc_commit}\``);
            const front_matter = lines.length ? lines.join('\n') + '\n\n' : '';

            const body = front_matter + [
              `hotfix continuation created from github's persistent ref \`refs/pull/${pr_number}/head\`.`,
              '',
              '---',
              ${{ toJson(steps.find.outputs.issue_body) }}
            ].join('\n');

            const pr = (await github.rest.pulls.create({ ...repo, title, head: head_ref, base: base_ref, body, draft: false })).data;

            const labels = JSON.parse('${{ steps.find.outputs.labels_json }}');
            if (labels.length) await github.rest.issues.addLabels({ ...repo, issue_number: pr.number, labels });

            const milestone = '${{ steps.find.outputs.milestone }}';
            if (milestone) await github.rest.issues.update({ ...repo, issue_number: pr.number, milestone: Number(milestone) });

            const assignees = JSON.parse('${{ steps.find.outputs.assignees_json }}');
            const final_assignees = assignees.length ? assignees : ['${{ github.event.issue.user.login }}'];
            await github.rest.issues.addAssignees({ ...repo, issue_number: pr.number, assignees: final_assignees });

            core.info(`hotfix pr opened: #${pr.number} ${pr.html_url}`)
